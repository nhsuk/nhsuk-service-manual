{% from "details/macro.njk" import details %}
{% from "tables/macro.njk" import table %}

{% macro designExample(params) %}
  {% set standaloneURL = "/design-example/" + params.group + "/" + params.item + "/" + params.type %}

  {# `showExample` and `showCode` is true, unless explicitly turned off with params #}
  {% set showExample = params.showExample !== false %}
  {% set showCode = params.showCode !== false %}

  {% set html %}
  {{- getHTMLCode(params) | highlight('html') | safe -}}
  {% endset %}

  {% set nunjucks %}
  {{- getNunjucksCode(params) | highlight('js') | safe -}}
  {% endset %}

  {#
  Set up the `snippets` array to be a definition of the types of snippet to
  display. If `params.htmlOnly` is true, the only snippet type to show is HTML.
  Otherwise we show HTML and nunjucks.

  Code definitions should be an object with a `name` and the raw `code` to
  render onto the page with the `|safe` filter.
  #}
  {% set htmlDefinition = {
    name: "HTML",
    code: html
  } %}
  {% set nunjucksDefinition = {
    name: "Nunjucks",
    code: nunjucks
  } %}
  {% if params.htmlOnly %}
    {% set snippets = [htmlDefinition] %}
  {% elif params.nunjucksOnly %}
    {% set snippets = [nunjucksDefinition] %}
  {% else %}
    {% set snippets = [htmlDefinition, nunjucksDefinition] %}
  {% endif %}

  {% set exampleType = params.type|lower|replace("-", " ") %}
  {% set exampleItem = params.item|lower|replace("-", " ") %}
  {% set exampleId = params.type + "-example" %}
  {% set exampleTitle = exampleType + " " + exampleItem %}

  <div class="app-design-example" data-module="app-design-example">

    {% if showExample %}
      <a href="{{ standaloneURL }}" class="app-design-example__pop-out" target="_blank" rel="noopener noreferrer">
        Open this<span class="nhsuk-u-visually-hidden"> {{ exampleTitle }}</span> example in a new tab
      </a>
      <div class="app-code-embed">
        <iframe title="{{ params.type }}" src="{{ standaloneURL }}" class="app-design-example__frame"></iframe>
      </div>
    {% endif %}

    {% if showCode %}
      <div class="app-code-snippet">
        {% if snippets | length > 1 %}
          <ul class="app-tabs" role="tablist">
            {% for snippet in snippets %}
              <li class="app-tabs__item" role="presentation" data-index="ex-{{ loop.index }}">
                <a href="javascript:void(0);" role="tab" aria-controls="{{ exampleId }}" data-track="tab-html" aria-selected="true">
                  {{ snippet.name }}<span class="nhsuk-u-visually-hidden"> code for {{ exampleTitle }}</span>
                </a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <div class="app-tabs__container js-tabs__container" id="{{ exampleId }}" role="tabpanel">
          {% for snippet in snippets %}
            {% if snippets | length > 1 %}
              <div class="app-tabs__item app-tabs__item--mobile" role="presentation" data-index="ex-{{ loop.index }}">
                <a href="" role="tab" aria-controls="{{ exampleId }}" data-track="tab-html" aria-selected="true">
                  {{ snippet.name }}<span class="nhsuk-u-visually-hidden"> code for {{ exampleTitle }}</span>
                </a>
              </div>
            {% endif %}
            <div class="app-code-snippet__preformatted {% if snippets|length > 1 %}js-hidden{% endif %}" data-index="ex-{{ loop.index }}">
              {% set nunjucksParams = getNunjucksParams(params.item) if params.group == "components" and snippet.name == "Nunjucks" else [] %}

              {% if nunjucksParams | length %}
                {% set optionRows = [] %}

                {% for option in nunjucksParams %}
                  {% set optionRows = (optionRows.push([
                    {
                      header: "Name",
                      text: option.name
                    },
                    {
                      header: "Type",
                      text: option.type
                    },
                    {
                      header: "Required",
                      text: option.required
                    },
                    {
                      header: "Description",
                      html: option.description | markdown
                    }
                  ]), optionRows) %}

                  {% if option.params %}
                    {% for subOption in option.params %}
                      {% set subOptionName = option.name ~ ("[]" if option.type == "array" else "{}") ~ "." ~ subOption.name %}

                      {% set optionRows = (optionRows.push([
                        {
                          header: "Name",
                          text: subOptionName
                        },
                        {
                          header: "Type",
                          text: subOption.type
                        },
                        {
                          header: "Required",
                          text: subOption.required
                        },
                        {
                          header: "Description",
                          html: subOption.description | markdown
                        }
                      ]), optionRows) %}

                      {% if subOption.params %}
                        {% for subSubOption in subOption.params %}
                          {% set subSubOptionName = subOptionName ~ ("[]" if subOption.type == "array" else "{}") ~ "." ~ subSubOption.name %}

                          {% set optionRows = (optionRows.push([
                            {
                              header: "Name",
                              text: subSubOptionName
                            },
                            {
                              header: "Type",
                              text: subSubOption.type
                            },
                            {
                              header: "Required",
                              text: subSubOption.required
                            },
                            {
                              header: "Description",
                              html: subSubOption.description | markdown
                            }
                          ]), optionRows) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}

                <div class="app-code-snippet__macro">
                  {% call details({
                    summaryText: "Nunjucks macro options"
                  }) %}
                    <p>Use options to customise the appearance, content and behaviour of a component when using a macro, for example, changing the text.</p>
                    <p>Some options are required for the macro to work. These are marked as "Required" in the option description.</p>
                    <p>If you're using Nunjucks macros in production with "html" options, or ones ending with "html", you must sanitise the HTML to protect against  <a href="https://developer.mozilla.org/en-US/docs/Glossary/Cross-site_scripting">cross-site scripting exploits</a>.</p>

                    {{ table({
                      caption: "Nunjucks arguments for " ~ exampleTitle,
                      captionClasses: "nhsuk-u-visually-hidden",
                      responsive: true,
                      head: [
                        {
                          text: "Name"
                        },
                        {
                          text: "Type"
                        },
                        {
                          text: "Required"
                        },
                        {
                          text: "Description"
                        }
                      ],
                      rows: optionRows
                    }) }}
                  {% endcall %}
                </div>
              {% endif %}
              <div class="app-code-snippet__macro"></div>
              <div class="app-code-snippet__container">
                <button class="app-button--copy" aria-live="assertive" hidden>
                  Copy code<span class="nhsuk-u-visually-hidden">: {{ exampleTitle }}</span>
                </button>

                <pre><code class="{{ snippet.language }}">
                  {{- snippet.code | safe -}}
                </code></pre>
              </div>
              {% if snippets | length > 1 %}
              <button class="app-button--close" hidden>
                Close<span class="nhsuk-u-visually-hidden">: {{ exampleTitle }}</span>
              </button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
{% endmacro %}
